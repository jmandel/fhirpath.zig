{
  "_spec_summary": [
    "FHIR primitives have a split representation in JSON: 'field' holds the value,",
    "'_field' holds metadata (id, extension). FHIRPath abstracts this away entirely.",
    "Per spec section 2.1.9.1: 'specific xml or json features are not visible to the",
    "FHIRPath language (such as comments and the split representation of primitives).'",
    "",
    "FHIR primitives specialize FHIR.Element and thus have three sub-properties:",
    "  - .value: the primitive value itself (implicit in most contexts)",
    "  - .id: optional id from _field metadata",
    "  - .extension: extensions from _field metadata",
    "",
    "Automatic type conversion (spec section 2.1.9.1.2):",
    "  FHIR.boolean -> System.Boolean",
    "  FHIR.string/uri/code/oid/id/uuid/markdown/base64Binary -> System.String",
    "  FHIR.integer/unsignedInt/positiveInt -> System.Integer",
    "  FHIR.integer64 -> System.Long",
    "  FHIR.decimal -> System.Decimal",
    "  FHIR.date/dateTime/instant -> System.DateTime",
    "  FHIR.time -> System.Time",
    "",
    "Key semantics:",
    "- hasValue() and empty() are NOT mutually exclusive on primitives. A primitive",
    "  with extensions but no value is not empty() (it has children) but hasValue()",
    "  returns false.",
    "- The spec says '.value will be included in the set returned by children() or",
    "  descendants()' for primitives that have a value.",
    "- _field keys and resourceType are JSON artifacts hidden from FHIRPath navigation.",
    "- Array primitives use parallel arrays: given[]/_given[] are merged element-wise.",
    "",
    "Output types use System type names (FHIR primitives are downcast at output time).",
    "Internally, items retain FHIR types for correct is()/ofType() behavior."
  ],
  "_todo": [
    "[x] Basic primitive value access with implicit type conversion (12/12 passing)",
    "[x] Extension navigation on primitives (.extension, .id, .value)",
    "[x] Array primitives with parallel _field merging",
    "[x] children() hides _field keys and resourceType",
    "[ ] Add test: hasValue() true for primitive with value",
    "[ ] Add test: hasValue() false for extension-only primitive (null value)",
    "[ ] Add test: empty() false for extension-only primitive",
    "[ ] Add test: is(FHIR.code) vs is(System.String) on gender",
    "[ ] Add test: descendants() on resource with primitive extensions"
  ],
  "meta": {
    "status": "reviewed",
    "feature": "fhir-primitive-extensions",
    "requires_model": true,
    "requires_fhir_json": true,
    "source": "spec/fhirpath-in-fhir.md section 2.1.9.1"
  },
  "cases": [
    {
      "_section": "=== Basic primitive value access (implicit conversion still works) ==="
    },
    {
      "name": "Patient.gender returns value",
      "comment": "gender is a code; value 'male' is accessible as usual. Output type is System.String per FHIR.code -> System.String mapping.",
      "expr": "Patient.gender",
      "input": {
        "resourceType": "Patient",
        "gender": "male",
        "_gender": {
          "extension": [{"url": "http://example.org/ext", "valueString": "context"}]
        }
      },
      "expect": [{"type": "System.String", "value": "male"}]
    },
    {
      "name": "Patient.birthDate returns value",
      "comment": "birthDate is a FHIR.date; output type is System.DateTime per spec mapping table.",
      "expr": "Patient.birthDate",
      "input": {
        "resourceType": "Patient",
        "birthDate": "1990-01-15",
        "_birthDate": {
          "id": "bd1",
          "extension": [{"url": "http://example.org/ext2", "valueCode": "approx"}]
        }
      },
      "expect": [{"type": "System.DateTime", "value": "1990-01-15"}]
    },
    {
      "name": "Patient.active returns boolean value",
      "comment": "active is a boolean with no _active metadata. Output type is System.Boolean.",
      "expr": "Patient.active",
      "input": {
        "resourceType": "Patient",
        "active": true
      },
      "expect": [{"type": "System.Boolean", "value": true}]
    },
    {
      "_section": "=== Extension navigation on primitives ==="
    },
    {
      "name": "Patient.gender.extension.count()",
      "comment": "gender has one extension in _gender. Merged into the logical primitive node.",
      "expr": "Patient.gender.extension.count()",
      "input": {
        "resourceType": "Patient",
        "gender": "male",
        "_gender": {
          "extension": [{"url": "http://example.org/ext", "valueString": "context"}]
        }
      },
      "expect": [{"type": "System.Integer", "value": 1}]
    },
    {
      "name": "Patient.gender.extension.first().url",
      "comment": "Navigate into the extension object to read url.",
      "expr": "Patient.gender.extension.first().url",
      "input": {
        "resourceType": "Patient",
        "gender": "male",
        "_gender": {
          "extension": [{"url": "http://example.org/ext", "valueString": "context"}]
        }
      },
      "expect": [{"type": "System.String", "value": "http://example.org/ext"}]
    },
    {
      "name": "Patient.birthDate.id",
      "comment": "birthDate has an id in _birthDate metadata.",
      "expr": "Patient.birthDate.id",
      "input": {
        "resourceType": "Patient",
        "birthDate": "1990-01-15",
        "_birthDate": {
          "id": "bd1",
          "extension": [{"url": "http://example.org/ext2", "valueCode": "approx"}]
        }
      },
      "expect": [{"type": "System.String", "value": "bd1"}]
    },
    {
      "name": "Patient.birthDate.extension.count()",
      "comment": "birthDate has one extension in _birthDate metadata.",
      "expr": "Patient.birthDate.extension.count()",
      "input": {
        "resourceType": "Patient",
        "birthDate": "1990-01-15",
        "_birthDate": {
          "id": "bd1",
          "extension": [{"url": "http://example.org/ext2", "valueCode": "approx"}]
        }
      },
      "expect": [{"type": "System.Integer", "value": 1}]
    },
    {
      "name": "Patient.birthDate.value",
      "comment": ".value on a primitive returns the value itself. Per spec, FHIR primitives have an implicit .value property.",
      "expr": "Patient.birthDate.value",
      "input": {
        "resourceType": "Patient",
        "birthDate": "1990-01-15",
        "_birthDate": {
          "id": "bd1"
        }
      },
      "expect": [{"type": "System.DateTime", "value": "1990-01-15"}]
    },
    {
      "name": "Patient.active.extension.count() is 0",
      "comment": "active has no _active metadata, so no extensions.",
      "expr": "Patient.active.extension.count()",
      "input": {
        "resourceType": "Patient",
        "active": true
      },
      "expect": [{"type": "System.Integer", "value": 0}]
    },
    {
      "_section": "=== Array primitives with parallel _field ==="
    },
    {
      "name": "Patient.name.given.count() includes all elements",
      "comment": "given has 2 elements: 'Alice' and null (extension-only). Both are included per spec: null values with _field metadata are valid FHIR primitives.",
      "expr": "Patient.name.given.count()",
      "input": {
        "resourceType": "Patient",
        "name": [{
          "family": "Smith",
          "given": ["Alice", null],
          "_given": [null, {"extension": [{"url": "http://example.org/ext3", "valueString": "nickname"}]}]
        }]
      },
      "expect": [{"type": "System.Integer", "value": 2}]
    },
    {
      "name": "Patient.name.given[1].extension.count()",
      "comment": "The second given element is null but has an extension via _given[1]. Extension is merged into the logical node.",
      "expr": "Patient.name.given[1].extension.count()",
      "input": {
        "resourceType": "Patient",
        "name": [{
          "family": "Smith",
          "given": ["Alice", null],
          "_given": [null, {"extension": [{"url": "http://example.org/ext3", "valueString": "nickname"}]}]
        }]
      },
      "expect": [{"type": "System.Integer", "value": 1}]
    },
    {
      "_section": "=== children() and descendants() behavior ==="
    },
    {
      "name": "children() does not include _gender or _birthDate or resourceType",
      "comment": "children() should return: id, gender, birthDate, active = 4 items. _gender, _birthDate are JSON split-representation artifacts hidden from FHIRPath. resourceType is also hidden from iteration.",
      "expr": "children().count()",
      "input": {
        "resourceType": "Patient",
        "id": "example",
        "gender": "male",
        "_gender": {
          "extension": [{"url": "http://example.org/ext", "valueString": "context"}]
        },
        "birthDate": "1990-01-15",
        "_birthDate": {
          "id": "bd1"
        },
        "active": true
      },
      "expect": [{"type": "System.Integer", "value": 4}]
    }
  ]
}
