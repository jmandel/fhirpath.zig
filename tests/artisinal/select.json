{
  "meta": {
    "status": "implemented",
    "feature": "select",
    "source": "spec/index.md#select(projection: expression)"
  },
  "spec": {
    "summary": [
      "select(projection) evaluates the projection for each item in the input collection and concatenates the results into a single output collection.",
      "If a projection result is empty, no element is added for that input item.",
      "If a projection yields multiple items, all of them are flattened into the output collection.",
      "The projection expression may refer to $this (current item) and $index (0-based index).",
      "If the input collection is empty, the result is empty."
    ],
    "examples": [
      "Bundle.entry.select(resource as Patient)",
      "Patient.name.where(use = 'usual').select(given.first() + ' ' + family)"
    ]
  },
  "todo": [
    "[x] Implement parsing of select() function calls.",
    "[x] Implement select() evaluation with per-item projection.",
    "[x] Flatten projection results into a single output collection.",
    "[x] Bind $this and $index within projection evaluation.",
    "[ ] Add error tests for projection expressions once error harness exists.",
    "[x] Improve passing rate (5/5 passing)."
  ],
  "cases": [
    {
      "name": "select identity with $this",
      "expr": "name.select($this)",
      "input": {
        "name": [
          "Ann",
          "Bob"
        ]
      },
      "expect": [
        {
          "type": "string",
          "value": "Ann"
        },
        {
          "type": "string",
          "value": "Bob"
        }
      ]
    },
    {
      "name": "select flattens nested collections",
      "expr": "name.select(given)",
      "input": {
        "name": [
          {
            "given": [
              "Ann",
              "Annie"
            ]
          },
          {
            "given": [
              "Bob"
            ]
          }
        ]
      },
      "expect": [
        {
          "type": "string",
          "value": "Ann"
        },
        {
          "type": "string",
          "value": "Annie"
        },
        {
          "type": "string",
          "value": "Bob"
        }
      ]
    },
    {
      "name": "select drops empty projection results",
      "expr": "name.select(text)",
      "input": {
        "name": [
          {
            "text": "Ann"
          },
          {
            "given": [
              "Bob"
            ]
          },
          {
            "text": "Cyd"
          }
        ]
      },
      "expect": [
        {
          "type": "string",
          "value": "Ann"
        },
        {
          "type": "string",
          "value": "Cyd"
        }
      ]
    },
    {
      "name": "select exposes $index",
      "expr": "given.select($index)",
      "input": {
        "given": [
          "Ann",
          "Bob",
          "Cyd"
        ]
      },
      "expect": [
        {
          "type": "integer",
          "value": 0
        },
        {
          "type": "integer",
          "value": 1
        },
        {
          "type": "integer",
          "value": 2
        }
      ]
    },
    {
      "name": "select over empty input yields empty",
      "expr": "name.select($this)",
      "input": {
        "name": []
      },
      "expect": []
    }
  ]
}
