{
  "meta": {
    "status": "implemented"
  },
  "_spec_summary": "UCUM vs Calendar Duration Quantity Handling\n\nFHIRPath distinguishes between calendar duration quantities and definite duration (UCUM) quantities.\n\n## Calendar Durations (keywords, no quotes)\nUsed for date/time arithmetic with calendar semantics:\n- year/years, month/months, week/weeks, day/days\n- hour/hours, minute/minutes, second/seconds, millisecond/milliseconds\n\nExamples: `1 year`, `4 days`, `30 minutes`\n\n## UCUM Definite Durations (quoted strings)\nRepresent fixed time intervals per UCUM:\n- 'a' (year ~365.25 days), 'mo' (month ~30.4375 days)\n- 'wk' (week =7 days), 'd' (day =24 hours)\n- 'h' (hour =60 min), 'min' (minute =60 s)\n- 's' (second), 'ms' (millisecond)\n\nExamples: `1 'a'`, `4 'd'`, `30 'min'`\n\n## Equivalence vs Equality Table (spec §6.2.2, §6.3.2)\n\n| Calendar Duration | UCUM Unit | Equivalence (~) | Equality (=) |\n|-------------------|-----------|-----------------|--------------|\n| year/years        | 'a'       | ~ 1 'a' (true)  | = 1 'a' ({}) |\n| month/months      | 'mo'      | ~ 1 'mo' (true) | = 1 'mo' ({}) |\n| week/weeks        | 'wk'      | ~ 1 'wk' (true) | = 1 'wk' (true) |\n| day/days          | 'd'       | ~ 1 'd' (true)  | = 1 'd' (true) |\n| hour/hours        | 'h'       | ~ 1 'h' (true)  | = 1 'h' (true) |\n| minute/minutes    | 'min'     | ~ 1 'min' (true)| = 1 'min' (true) |\n| second/seconds    | 's'       | ~ 1 's' (true)  | = 1 's' (true) |\n| millisecond/ms    | 'ms'      | ~ 1 'ms' (true) | = 1 'ms' (true) |\n\nNote: For second/ms, the spec shows `= 1 's'` (equal) rather than `~` because they are exactly equal to UCUM seconds. Equal implies equivalent, so ~ also returns true.\n\nKey insight: 'above days (and weeks) are considered un-comparable' means\nyear/month return empty for equality, but day/week/hour/minute/second/ms are comparable.\n\n## Date/Time Arithmetic with UCUM Units\n\nThe spec says: 'the quantity unit must be one of: years, months, weeks, days, hours, minutes, seconds, or milliseconds (or an equivalent unit)'.\n\nUCUM units 'd', 'wk', 'h', 'min', 's', 'ms' are 'equivalent units' and work:\n- `@2024-01-01 + 1 'd'` → works (R5 testPlusDate13)\n- `@2024-01-01 + 1 'wk'` → works (R5 testPlusDate15)\n- `@2024-01-01T00:00:00 + 1 'h'` → works (R5 testPlusDate22)\n- `@2024-01-01T00:00:00 + 1 'min'` → works (R5 testPlusDate21)\n\nBut 'mo' and 'a' are NOT equivalent units (only ~ equivalent, not = equal):\n- `@2024-01-01 + 1 'mo'` → ERROR (R5 testPlusDate14 expect_error)\n- `@2024-01-01 + 1 'a'` → ERROR (R5 testPlusDate16/17 expect_error)\n\n## Calendar Duration Conversion Factors (spec §5.10.1 toQuantity)\n\nFor calendar duration conversions:\n- 1 year = 12 months OR 365 days\n- 1 month = 30 days\n- 1 week = 7 days\n- 1 day = 24 hours\n- 1 hour = 60 minutes\n- 1 minute = 60 seconds\n- 1 second = 1 's'\n\n## Key Test Patterns\n\n1. Calendar keywords work for all date/time arithmetic\n2. UCUM 'd'/'wk'/'h'/'min'/'s'/'ms' work as equivalent units\n3. UCUM 'mo'/'a' cause ERROR in date/time arithmetic (not empty!)\n4. Equality of year/month with UCUM returns EMPTY (not error)\n5. Equivalence (~) works for all calendar/UCUM pairs",
  "_todo": [
    "[x] All 43/43 tests passing",
    "[x] Implement UCUM unit conversion for date/time arithmetic ('d', 'wk', 'h', 'min', 's', 'ms')",
    "[x] Implement UCUM to calendar equivalence for quantities",
    "[x] Implement calendar duration equality (days/weeks comparable, months/years empty)",
    "[x] Handle 'mo' and 'a' ERROR for date/time arithmetic",
    "[x] Support fractional UCUM seconds (0.1 's')",
    "[x] Support calendar duration comparison (7 days = 1 week)"
  ],
  "cases": [
    {
      "name": "UCUM 'd' in date arithmetic works",
      "expr": "@2024-01-01 + 1 'd'",
      "input": {},
      "expect": [
        {
          "type": "date",
          "value": "2024-01-02"
        }
      ],
      "comment": "R5 testPlusDate13: UCUM 'd' is equivalent to calendar 'day'",
      "_adjudicated": {
        "engines": {
          "fhirpath_js": [{"type": "dateTime", "value": "2024-01-02"}]
        },
        "our_old_value": null,
        "verdict": "ours_correct",
        "reason": "Spec says 'Returns the value of the given Date' - result type should match input. Input @2024-01-01 is a Date, result should be Date not DateTime. fhirpath.js incorrectly reports the type as dateTime.",
        "spec_ref": "§6.6 + (addition) date/time arithmetic",
        "official_test": "testPlusDate13"
      }
    },
    {
      "name": "UCUM 'wk' in date arithmetic works",
      "expr": "@2024-01-01 + 1 'wk'",
      "input": {},
      "expect": [
        {
          "type": "date",
          "value": "2024-01-08"
        }
      ],
      "comment": "R5 testPlusDate15: UCUM 'wk' is equivalent to calendar 'week'"
    },
    {
      "name": "UCUM 'mo' in date arithmetic is ERROR",
      "expr": "@2024-01-01 + 1 'mo'",
      "input": {},
      "expect_error": true,
      "comment": "R5 testPlusDate14: 'mo' is NOT an equivalent unit, signals error"
    },
    {
      "name": "UCUM 'a' in date arithmetic is ERROR",
      "expr": "@2024-01-01 + 1 'a'",
      "input": {},
      "expect_error": true,
      "comment": "R5 testPlusDate16/17: 'a' is NOT an equivalent unit, signals error"
    },
    {
      "name": "UCUM 'h' in datetime arithmetic works",
      "expr": "@2024-01-01T00:00:00 + 1 'h'",
      "input": {},
      "expect": [
        {
          "type": "dateTime",
          "value": "2024-01-01T01:00:00"
        }
      ],
      "comment": "R5 testPlusDate22: UCUM 'h' is equivalent to calendar 'hour'"
    },
    {
      "name": "UCUM 'min' in datetime arithmetic works",
      "expr": "@2024-01-01T00:00:00 + 1 'min'",
      "input": {},
      "expect": [
        {
          "type": "dateTime",
          "value": "2024-01-01T00:01:00"
        }
      ],
      "comment": "R5 testPlusDate21: UCUM 'min' is equivalent to calendar 'minute'",
      "_adjudicated": {
        "engines": {
          "fhirpath_js": [{"type": "dateTime", "value": "2024-01-01T00:01:00-06:00"}]
        },
        "our_old_value": null,
        "verdict": "ours_correct",
        "reason": "fhirpath.js appends the local timezone offset (-06:00) to the result, but the input literal @2024-01-01T00:00:00 has no timezone. The spec does not say to inject timezone information during arithmetic. The result should preserve the input's precision/structure.",
        "spec_ref": "§6.6 + (addition) date/time arithmetic",
        "official_test": "testPlusDate21"
      }
    },
    {
      "name": "UCUM 's' in datetime arithmetic is valid",
      "expr": "@2024-01-01T00:00:00 + 1 's'",
      "input": {},
      "expect": [
        {
          "type": "dateTime",
          "value": "2024-01-01T00:00:01"
        }
      ],
      "comment": "R5 testPlusDate18: UCUM 's' is equal to calendar 'second'"
    },
    {
      "name": "UCUM 'ms' in datetime arithmetic is valid",
      "expr": "@2024-01-01T00:00:00.000 + 100 'ms'",
      "input": {},
      "expect": [
        {
          "type": "dateTime",
          "value": "2024-01-01T00:00:00.100"
        }
      ],
      "comment": "R5 testPlusDate20: UCUM 'ms' is equal to calendar 'millisecond'"
    },
    {
      "name": "calendar 'day' in date arithmetic works",
      "expr": "@2024-01-01 + 1 day",
      "input": {},
      "expect": [
        {
          "type": "date",
          "value": "2024-01-02"
        }
      ],
      "comment": "Calendar duration keywords work with date arithmetic"
    },
    {
      "name": "calendar 'week' in date arithmetic works",
      "expr": "@2024-01-01 + 1 week",
      "input": {},
      "expect": [
        {
          "type": "date",
          "value": "2024-01-08"
        }
      ],
      "comment": "Calendar duration keywords work with date arithmetic"
    },
    {
      "name": "calendar 'month' in date arithmetic works",
      "expr": "@2024-01-15 + 1 month",
      "input": {},
      "expect": [
        {
          "type": "date",
          "value": "2024-02-15"
        }
      ],
      "comment": "Calendar duration keywords work with date arithmetic"
    },
    {
      "name": "calendar 'year' in date arithmetic works",
      "expr": "@2024-01-15 + 1 year",
      "input": {},
      "expect": [
        {
          "type": "date",
          "value": "2025-01-15"
        }
      ],
      "comment": "Calendar duration keywords work with date arithmetic"
    },
    {
      "name": "equivalence: year ~ 'a' is true",
      "expr": "1 year ~ 1 'a'",
      "input": {},
      "expect": [
        {
          "type": "boolean",
          "value": true
        }
      ],
      "comment": "Spec §6.3.2: year/years ~ 1 'a' (calendar/UCUM equivalence)"
    },
    {
      "name": "equivalence: month ~ 'mo' is true",
      "expr": "1 month ~ 1 'mo'",
      "input": {},
      "expect": [
        {
          "type": "boolean",
          "value": true
        }
      ],
      "comment": "Spec §6.3.2: month/months ~ 1 'mo' (calendar/UCUM equivalence)"
    },
    {
      "name": "equivalence: week ~ 'wk' is true",
      "expr": "1 week ~ 1 'wk'",
      "input": {},
      "expect": [
        {
          "type": "boolean",
          "value": true
        }
      ],
      "comment": "Spec §6.3.2: week/weeks ~ 1 'wk' (calendar/UCUM equivalence)"
    },
    {
      "name": "equivalence: day ~ 'd' is true",
      "expr": "1 day ~ 1 'd'",
      "input": {},
      "expect": [
        {
          "type": "boolean",
          "value": true
        }
      ],
      "comment": "Spec §6.3.2: day/days ~ 1 'd' (calendar/UCUM equivalence)"
    },
    {
      "name": "equivalence: hour ~ 'h' is true",
      "expr": "1 hour ~ 1 'h'",
      "input": {},
      "expect": [
        {
          "type": "boolean",
          "value": true
        }
      ],
      "comment": "Spec §6.3.2: hour/hours ~ 1 'h' (calendar/UCUM equivalence)"
    },
    {
      "name": "equivalence: minute ~ 'min' is true",
      "expr": "1 minute ~ 1 'min'",
      "input": {},
      "expect": [
        {
          "type": "boolean",
          "value": true
        }
      ],
      "comment": "Spec §6.3.2: minute/minutes ~ 1 'min' (calendar/UCUM equivalence)"
    },
    {
      "name": "equality: second = 's' is true",
      "expr": "1 second = 1 's'",
      "input": {},
      "expect": [
        {
          "type": "boolean",
          "value": true
        }
      ],
      "comment": "Spec table: second/seconds = 1 's' (equal, not just equivalent)"
    },
    {
      "name": "equality: millisecond = 'ms' is true",
      "expr": "1 millisecond = 1 'ms'",
      "input": {},
      "expect": [
        {
          "type": "boolean",
          "value": true
        }
      ],
      "comment": "Spec table: millisecond/milliseconds = 1 'ms' (equal, not just equivalent)"
    },
    {
      "name": "equality: year = 'a' returns empty (incomparable)",
      "expr": "1 year = 1 'a'",
      "input": {},
      "expect": [],
      "comment": "Spec §6.2.2 example: 1 year = 1 'a' // {} an empty collection"
    },
    {
      "name": "equality: month = 'mo' returns empty (incomparable)",
      "expr": "1 month = 1 'mo'",
      "input": {},
      "expect": [],
      "comment": "Spec §6.2.2: months are 'above days (and weeks)' so un-comparable"
    },
    {
      "name": "equality: day = 'd' is true (comparable)",
      "expr": "1 day = 1 'd'",
      "input": {},
      "expect": [
        {
          "type": "boolean",
          "value": true
        }
      ],
      "comment": "Spec: days are comparable (not 'above days'). R5 testStringQuantityDayLiteralToQuantity confirms."
    },
    {
      "name": "equality: week = 'wk' is true (comparable)",
      "expr": "1 week = 1 'wk'",
      "input": {},
      "expect": [
        {
          "type": "boolean",
          "value": true
        }
      ],
      "comment": "Spec: weeks are comparable (not 'above days (and weeks)')"
    },
    {
      "name": "equality: hour = 'h' is true (comparable)",
      "expr": "1 hour = 1 'h'",
      "input": {},
      "expect": [
        {
          "type": "boolean",
          "value": true
        }
      ],
      "comment": "Spec: hours are below days, so comparable"
    },
    {
      "name": "equality: minute = 'min' is true (comparable)",
      "expr": "1 minute = 1 'min'",
      "input": {},
      "expect": [
        {
          "type": "boolean",
          "value": true
        }
      ],
      "comment": "Spec: minutes are below days, so comparable"
    },
    {
      "name": "comparison: year > 'a' returns empty",
      "expr": "1 year > 1 'a'",
      "input": {},
      "expect": [],
      "comment": "Spec §6.4.1 example: 1 year > 1 'a' // {} (empty)"
    },
    {
      "name": "comparison: 10 seconds > 1 's' is true",
      "expr": "10 seconds > 1 's'",
      "input": {},
      "expect": [
        {
          "type": "boolean",
          "value": true
        }
      ],
      "comment": "Spec §6.4.1 example: 10 seconds > 1 's' // true"
    },
    {
      "name": "fractional UCUM seconds in arithmetic",
      "expr": "@2024-01-01T00:00:00.000 + 0.1 's'",
      "input": {},
      "expect": [
        {
          "type": "dateTime",
          "value": "2024-01-01T00:00:00.100"
        }
      ],
      "comment": "R5 testPlusDate19: fractional seconds work with UCUM 's'"
    },
    {
      "name": "UCUM subtraction 'd' works",
      "expr": "@2024-01-02 - 1 'd'",
      "input": {},
      "expect": [
        {
          "type": "date",
          "value": "2024-01-01"
        }
      ],
      "comment": "UCUM 'd' subtraction equivalent to calendar 'day' subtraction"
    },
    {
      "name": "UCUM subtraction 's' is valid",
      "expr": "@2024-01-01T00:00:01 - 1 's'",
      "input": {},
      "expect": [
        {
          "type": "dateTime",
          "value": "2024-01-01T00:00:00"
        }
      ],
      "comment": "Subtraction with 's' should work"
    },
    {
      "name": "time value + 'h' works",
      "expr": "@T10:00:00 + 1 'h'",
      "input": {},
      "expect": [
        {
          "type": "time",
          "value": "11:00:00"
        }
      ],
      "comment": "UCUM 'h' in time arithmetic equivalent to calendar 'hour'"
    },
    {
      "name": "time value + 's' works",
      "expr": "@T10:00:00 + 30 's'",
      "input": {},
      "expect": [
        {
          "type": "time",
          "value": "10:00:30"
        }
      ],
      "comment": "UCUM seconds in time arithmetic should work"
    },
    {
      "name": "time value + 'ms' works",
      "expr": "@T10:00:00.000 + 500 'ms'",
      "input": {},
      "expect": [
        {
          "type": "time",
          "value": "10:00:00.500"
        }
      ],
      "comment": "UCUM milliseconds in time arithmetic should work"
    },
    {
      "name": "quantity conversion: toQuantity with calendar duration",
      "expr": "'1 day'.toQuantity()",
      "input": {},
      "expect": [
        {
          "type": "Quantity",
          "value": {
            "value": 1,
            "unit": "day"
          }
        }
      ],
      "comment": "String to quantity should parse calendar duration keywords"
    },
    {
      "name": "quantity conversion: toQuantity with UCUM unit",
      "expr": "'1 \\'d\\''.toQuantity()",
      "input": {},
      "expect": [
        {
          "type": "Quantity",
          "value": {
            "value": 1,
            "unit": "d"
          }
        }
      ],
      "comment": "String to quantity should parse quoted UCUM units"
    },
    {
      "name": "R5 testQuantity5: 7 days = 1 week",
      "expr": "7 days = 1 week",
      "input": {},
      "expect": [
        {
          "type": "boolean",
          "value": true
        }
      ],
      "comment": "R5 test: calendar durations convert for comparison (1 week = 7 days)"
    },
    {
      "name": "R5 testQuantity6: 7 days = 1 'wk'",
      "expr": "7 days = 1 'wk'",
      "input": {},
      "expect": [
        {
          "type": "boolean",
          "value": true
        }
      ],
      "comment": "R5 test: calendar days and UCUM weeks are comparable (7d = 1wk)"
    },
    {
      "name": "R5 testQuantity7: 6 days < 1 week",
      "expr": "6 days < 1 week",
      "input": {},
      "expect": [
        {
          "type": "boolean",
          "value": true
        }
      ],
      "comment": "R5 test: calendar durations convert for comparison"
    },
    {
      "name": "R5 testQuantity8: 8 days > 1 week",
      "expr": "8 days > 1 week",
      "input": {},
      "expect": [
        {
          "type": "boolean",
          "value": true
        }
      ],
      "comment": "R5 test: calendar durations convert for comparison"
    },
    {
      "name": "multiple UCUM seconds add up correctly",
      "expr": "@2024-01-01T00:00:00 + 61 's'",
      "input": {},
      "expect": [
        {
          "type": "dateTime",
          "value": "2024-01-01T00:01:01"
        }
      ],
      "comment": "61 seconds should roll over to 1 minute 1 second"
    },
    {
      "name": "multiple UCUM milliseconds add up correctly",
      "expr": "@2024-01-01T00:00:00.000 + 1500 'ms'",
      "input": {},
      "expect": [
        {
          "type": "dateTime",
          "value": "2024-01-01T00:00:01.500"
        }
      ],
      "comment": "1500 ms should become 1.5 seconds"
    },
    {
      "name": "negative UCUM seconds work",
      "expr": "@2024-01-01T00:01:00 - 30 's'",
      "input": {},
      "expect": [
        {
          "type": "dateTime",
          "value": "2024-01-01T00:00:30"
        }
      ],
      "comment": "Subtracting seconds should work with UCUM 's'"
    }
  ]
}
