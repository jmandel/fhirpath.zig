# Bug Backlog (YAML)
#
# Format is simple YAML for deterministic parsing by scripts.
# Only single-line values are supported.
#
# Allowed status values (convention): open, in_progress, blocked, resolved, wontfix
# Allowed severity values (convention): low, medium, high, critical

version: 1
bugs:
  - slug: result-nodes-lack-metadata
    status: resolved
    severity: medium
    title: Result nodes lack metadata
    description: Evaluator returns raw std.json.Value with no type_id, source_pos, or data_kind. Blocks zero-copy spans and type-aware ops. See design.md Item layout.
    created: "2026-01-27T08:00:00-06:00"
    updated: "2026-01-27T19:30:00-06:00"
    tags: []
  - slug: artisinal-env-support
    status: resolved
    severity: medium
    title: Artisinal env not supported
    description: Harness ignores env field. Was fixed in 4466e76 but regressed in ea7d2da during harness refactor. Need to re-add env parsing and pass to eval context.
    created: "2026-01-27T08:00:00-06:00"
    updated: 2026-01-27
    tags: []
  - slug: harness-memory-leaks
    status: resolved
    severity: medium
    title: Fix memory leaks in test harness
    description: Harness leaks memory when formatting failure output (valueAlloc not freed). Shows gpa errors on test failures.
    created: "2026-01-27T08:00:00-06:00"
    updated: "2026-01-27T19:15:00-06:00"
    tags: [harness, memory]
  - slug: eval-leaks-intermediate-arraylists-during-harness-runs
    status: resolved
    severity: medium
    title: Eval leaks intermediate ArrayLists during harness runs
    description: Running zig build harness with GPA reports leaks from eval.zig (distinctItems/applySegment) even though eval_result.deinit is called; see stack traces in harness output after failures.
    created: "2026-01-27T08:00:00-06:00"
    updated: "2026-01-27T19:30:00-06:00"
    tags: [memory, eval]
  - slug: harness-comment-only-entries
    status: resolved
    severity: low
    title: Harness counts comment-only entries as failures
    description: Section header entries in artisinal test files (entries with only _comment field) are counted as failures because they lack an expr field. These should be skipped.
    created: 2026-01-27
    updated: 2026-01-27
    tags: [harness]
  - slug: memory-leaks-in-parser-harness
    status: resolved
    severity: medium
    title: Memory leaks in parser/harness
    description: GPA reports memory leaks in parsePrimary (dupe lexeme) and harness (allocPrint)
    created: 2026-01-28
    updated: 2026-01-28
    tags: [parser, harness, memory]
  - slug: boundary-functions
    status: resolved
    severity: high
    title: Implement lowBoundary() and highBoundary() functions
    description: Date/time boundary functions not implemented. ~25 R5 test failures. Spec §5.6.5.
    created: 2026-01-28
    updated: 2026-01-28
    tags: [functions, datetime]
  - slug: type-checking-operators
    status: resolved
    severity: high
    title: Fix is()/as()/ofType() type checking with FHIR types
    description: Type operators return wrong results for FHIR types (Quantity, instant, etc). ~24 R5 failures. Need schema integration.
    created: 2026-01-28
    updated: 2026-01-28
    tags: [types, functions]
  - slug: type-introspection
    status: resolved
    severity: medium
    title: Implement type() function returning namespace/name
    description: type() should return object with .namespace and .name fields. ~7 R5 failures. Spec §5.1.
    created: 2026-01-28
    updated: 2026-01-28
    tags: [functions, types]
  - slug: define-variable-scoping
    status: open
    severity: medium
    title: Implement defineVariable() scoping rules
    description: defineVariable() not respecting scope boundaries - should error when accessing vars outside their scope. ~10 R5 failures expecting errors.
    created: 2026-01-28
    updated: 2026-01-28
    tags: [functions, variables]
  - slug: polymorphic-choice-types
    status: open
    severity: high
    title: Support FHIR polymorphic choice types (value[x])
    description: Accessing Observation.value should find valueQuantity/valueString/etc. Observation.valueQuantity should work when value is Quantity. ~8 R5 failures.
    created: 2026-01-28
    updated: 2026-01-28
    tags: [fhir, types]
  - slug: tree-traversal-functions
    status: resolved
    severity: medium
    title: Implement repeat() and descendants() tree traversal
    description: repeat(expr) and descendants() not implemented. ~8 R5 failures. Spec §5.2.
    created: 2026-01-28
    updated: 2026-01-28
    tags: [functions]
  - slug: has-value-function
    status: open
    severity: low
    title: Implement hasValue() for primitive extensions
    description: hasValue() should return false for primitives with only extensions (no actual value). ~4 R5 failures. FHIR-specific.
    created: 2026-01-28
    updated: 2026-01-28
    tags: [functions, fhir]
  - slug: extension-function
    status: open
    severity: medium
    title: Implement extension() function for FHIR extensions
    description: extension(url) should filter to extensions matching the URL. ~6 R5 failures.
    created: 2026-01-28
    updated: 2026-01-28
    tags: [functions, fhir]
  - slug: datetime-comparison-today-now
    status: resolved
    severity: medium
    title: Fix date/datetime comparison with today()/now()
    description: Comparisons like 'birthDate < today()' failing. ~6 R5 failures. May be type coercion issue.
    created: 2026-01-28
    updated: 2026-01-28
    tags: [datetime, comparison]
  - slug: sort-descending
    status: open
    severity: low
    title: Implement sort() with descending (-) modifier
    description: sort(-field) for descending order not implemented. ~2 R5 failures.
    created: 2026-01-28
    updated: 2026-01-28
    tags: [functions]
  - slug: to-quantity-function
    status: resolved
    severity: low
    title: Implement toQuantity() conversion function
    description: toQuantity() for converting strings/numbers to Quantity. ~4 R5 failures.
    created: 2026-01-28
    updated: 2026-01-28
    tags: [functions, conversion]
  - slug: comparable-function
    status: open
    severity: low
    title: Implement comparable() function
    description: comparable() checks if two quantities can be compared. ~3 R5 failures.
    created: 2026-01-28
    updated: 2026-01-28
    tags: [functions]
  - slug: conforms-to-function
    status: resolved
    severity: low
    title: Implement conformsTo() for profile validation
    description: conformsTo(url) checks if resource conforms to a profile. ~2 R5 failures. FHIR-specific.
    created: 2026-01-28
    updated: 2026-01-28
    tags: [functions, fhir]
  - slug: children-descendants-return-wrong-types-no-schema-traversal
    status: open
    severity: high
    title: children()/descendants() return wrong types (no schema traversal)
    description: "children() and descendants() call itemFromNode with type_id=0, falling to typeIdForNode heuristic that guesses types from string content. All strings get wrong System.Date/DateTime/Time types instead of FHIR schema types. Fix: use parent type_id + entry.key with schema.childTypeForField, mirroring applySegment."
    created: 2026-01-28
    updated: 2026-01-28
    tags: [types, eval, schema]
  - slug: typeidfornode-string-heuristics-are-too-loose
    status: resolved
    severity: low
    title: typeIdForNode string heuristics are too loose
    description: typeIdForNode guesses string types via isDate (has dash), isDateTime (has T), isTime (has colon). These match normal strings like PleasantVille, VT, 555-1234. Should use proper date/time patterns. Secondary to schema-aware traversal fix but affects no-schema fallback.
    created: 2026-01-28
    updated: 2026-01-28
    tags: [types, eval]
  - slug: fhir-environment-variables
    status: open
    severity: medium
    title: Initialize FHIR built-in environment variables (%sct, %loinc, %ucum, %vs-*)
    description: "FHIRPath defines built-in env vars: %sct='http://snomed.info/sct', %loinc='http://loinc.org', %ucum='http://unitsofmeasure.org', %vs-*='http://hl7.org/fhir/ValueSet/*'. These are not initialized. ~4 R5 failures (testVariables1-4). See spec/fhirpath-in-fhir.md §3.2."
    created: 2026-01-29
    updated: 2026-01-29
    tags: [fhir, environment]
  - slug: fhir-primitive-type-output
    status: open
    severity: medium
    title: FHIR primitive types not preserved in output (code/id/date show as System.String)
    description: When evaluating with FhirJsonAdapter+schema, primitive FHIR types like code, id, date are output as System.String instead of their FHIR type names. Tests expect type=code/id/date but get System.String. ~6 R5 failures (testExtractBirthDate, testPatientTelecomTypes, testContainedId, testFHIRPathAsFunction12/17/22). See spec/fhirpath-in-fhir.md for type mapping table.
    created: 2026-01-29
    updated: 2026-01-29
    tags: [fhir, types, output]
  - slug: ucum-quantity-conversion
    status: open
    severity: high
    title: Implement UCUM quantity unit conversion for comparison and arithmetic
    description: "Quantity comparisons/arithmetic only work with identical units. Need UCUM conversion: 4g=4000mg, 2cm*2m=0.04m2, 1m/1m=1'1'. ~12 R5 failures (testQuantity1/2/4/9/11, testEquality28, testEquivalent22, testLessThan22, testLessOrEqual22, testGreatorOrEqual22, testGreaterThan22, testAbs3). Largest single failure cluster."
    created: 2026-01-29
    updated: 2026-01-29
    tags: [functions, quantity, ucum]
  - slug: resolve-function
    status: open
    severity: medium
    title: Implement resolve() function for FHIR References
    description: resolve() function not implemented. Should follow Reference.reference to find the target resource within %resource or contained resources. ~1 R5 failure (testMultipleResolve). FHIR-specific function, see spec/fhirpath-in-fhir.md.
    created: 2026-01-29
    updated: 2026-01-29
    tags: [functions, fhir]
  - slug: arithmetic-type-validation
    status: open
    severity: medium
    title: Reject invalid arithmetic type combinations (date+int, string-string, date-non-duration)
    description: "Arithmetic operators accept invalid type combos: date+integer should error (only quantity duration allowed), string-string should error (only + is concat), date-non-duration-quantity should error. ~3 R5 failures (testPlus6, testMinus4, testMinus6). Spec §6.3."
    created: 2026-01-29
    updated: 2026-01-29
    tags: [operators, types]
  - slug: time-literal-timezone
    status: open
    severity: low
    title: "Reject time literals with timezone (e.g., @T14:34:28Z)"
    description: "FHIRPath spec says Time values cannot have timezone. Parser accepts @T14:34:28Z and @T14:34:28+10:00 when it should reject them. ~2 R5 failures (testLiteralTimeUTC, testLiteralTimeTimezoneOffset). Spec §2.2."
    created: 2026-01-29
    updated: 2026-01-29
    tags: [parser, datetime]
  - slug: unknown-type-name-errors
    status: open
    severity: low
    title: as()/ofType() with unknown type names should error
    description: as(string1) and ofType(string1) succeed silently when string1 is not a known type. Should return error for unresolvable type names. ~2 R5 failures (testFHIRPathAsFunction23/24).
    created: 2026-01-29
    updated: 2026-01-29
    tags: [types, functions]
  - slug: schema-property-validation
    status: open
    severity: medium
    title: Invalid property names should error when schema available
    description: name.given1 succeeds (returns empty) instead of erroring. With a schema, accessing a property that doesn't exist on the type should produce an error. Also Encounter.name.given on a Patient should error (wrong resource type). ~2 R5 failures (testSimpleFail, testSimpleWithWrongContext). See spec/fhirpath-in-fhir.md for FHIR model rules.
    created: 2026-01-29
    updated: 2026-01-29
    tags: [schema, eval, fhir]
  - slug: not-singleton-error
    status: resolved
    severity: low
    title: not() should error on non-singleton input
    description: not() returns empty for multi-item input instead of erroring. (1|2).not() should throw SingletonRequired. Currently returns empty collection. ~1 R5 failure (testNotInvalid). Spec §5.5.2.
    created: 2026-01-29
    updated: 2026-01-29
    tags: [functions, errors]
  - slug: string-function-invocation-in-select
    status: open
    severity: medium
    title: String function calls on implicit $this in select/where context cause eval errors
    description: Expressions like where(substring($this.length()-3)='out') and select(startsWith(length().toString())) fail with eval errors. Affects chained method calls on $this within select/where predicates. Also affects union() inside select(). ~9 R5 failures (testDollarThis1/2, testSubstring10, testStartsWith12, testEndsWith10, testContainsString10, testUnion10/11, testIndex).
    created: 2026-01-29
    updated: 2026-01-29
    tags: [eval, functions, context]
  - slug: boundary-precision-argument
    status: open
    severity: medium
    title: lowBoundary/highBoundary with precision argument return wrong results
    description: "lowBoundary(6) and highBoundary(6) on dates and highBoundary(17) on dateTimes produce incorrect values. @2014.lowBoundary(6) should return 2014-01 but doesn't. @2014-01-01T08.highBoundary(17) should return 2014-01-01T08:00:59.999-12:00. ~4 R5 failures (LowBoundaryDateMonth, HighBoundaryDateMonth, HighBoundaryDateTimeMillisecond1/3). Spec §5.6.5."
    created: 2026-01-29
    updated: 2026-01-29
    tags: [functions, datetime]
  - slug: decimal-arithmetic-precision
    status: open
    severity: medium
    title: Decimal arithmetic loses precision (1.8-1.2 \!= 0.6)
    description: "Decimal subtraction and mod produce imprecise results: 1.8-1.2 should equal 0.6 but doesn't; 2.2 mod 1.8 should equal 0.4 but doesn't. Likely floating-point representation issue in decimal implementation. ~2 R5 failures (testMinus3, testMod4)."
    created: 2026-01-29
    updated: 2026-01-29
    tags: [operators, decimal]
  - slug: ordered-collection-tracking
    status: open
    severity: low
    title: Track ordered vs unordered collections (children().skip() should error)
    description: children() returns an unordered collection per FHIR spec. Operations like skip() that require ordering should error on unordered input. Currently Patient.children().skip(1) succeeds. ~1 R5 failure (testDollarOrderNotAllowed). See spec/fhirpath-in-fhir.md.
    created: 2026-01-29
    updated: 2026-01-29
    tags: [eval, fhir, collections]
  - slug: type-inheritance-is-check
    status: open
    severity: medium
    title: is(string) should return true for FHIR code type (type inheritance)
    description: Patient.gender.is(string) returns false but should return true because FHIR code inherits from FHIR string which maps to System.String. The is() function needs to walk the type inheritance chain via schema base_type_id. ~1 R5 failure (testFHIRPathIsFunction2). See spec/fhirpath-in-fhir.md type hierarchy.
    created: 2026-01-29
    updated: 2026-01-29
    tags: [types, functions, fhir]
  - slug: terminologies-host-function
    status: open
    severity: low
    title: Implement %terminologies host functions (expand, validateVS, translate)
    description: The %terminologies environment variable and its methods (expand, validateVS, translate) are not supported. These are FHIR-specific host functions that require a terminology service. ~3 R5 failures (txTest01-03). Low priority as these require external service integration. See spec/fhirpath-in-fhir.md §3.3.
    created: 2026-01-29
    updated: 2026-01-29
    tags: [fhir, functions, host]
